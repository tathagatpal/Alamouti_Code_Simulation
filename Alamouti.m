%% Data Generation and BPSK Modulation
x = randi([0 1],1,1000);
x_bpsk = pskmod(x,2);
% scatterplot(x_bpsk)

snr_db = -5:0.1:30;

%% Alamouti Coding
% SNR = Eb/No => SNR (dB) = Eb/No (dB) + 10 log10 (2)
Eb_No_dB = snr_db;
Eb_No = 10.^(Eb_No_dB/10);

% x_bpsk = reshape(x_bpsk,length(x_bpsk)/2,2);

% Alamouti Encoder
alamouti_encoding = comm.OSTBCEncoder;
x_alamouti = alamouti_encoding(x_bpsk');

%% H_SISO
rayleighchan = comm.RayleighChannel;
y_siso = rayleighchan(x_bpsk');
H_SISO = rayleighchan(x_bpsk');

%% Alamouti Channel Matrix MISO
H_MISO = zeros(length(x_bpsk)/2, 2, 1);

% Half data in time instant 1 => Odd numbered symbols
H_MISO(1:2:length(x_bpsk), 1:end) = (randn([length(x_bpsk)/2 2]) ...
    + 1i*randn([length(x_bpsk)/2 2]))/sqrt(2);
% Half data goes in time instant 2 => Even numbered symbols
H_MISO(2:2:length(x_bpsk), 1:end) = H_MISO(1:2:length(x_bpsk), 1:end);


% Divide Power equally among 2 Tx Antennas
H_MISO = H_MISO/sqrt(2);

%% Alamouti Encoding MIMO
H_MIMO = zeros(2*length(x_bpsk),2,1);
for i = 1:4:length(x_bpsk)*2
        H_MIMO(i,1:end)=(randn([1 2])+1i*randn([1 2]))/sqrt(2);
        H_MIMO(i+1,1:end)=H_MIMO(i,1:end);
        H_MIMO(i+2,1:end)=(randn([1 2])+1i*randn([1 2]))/sqrt(2);
        H_MIMO(i+3,1:end)=H_MIMO(i+2,1:end);
end
% Divide Power equally among 2 Tx Antennas
H_MIMO = H_MIMO/sqrt(2);

%% Calculating BER (Alamouti Decoder + BPSK Demodulation)
ber_simulation_miso = zeros(length(snr_db), 1);
ber_simulation_MIMO = zeros(length(snr_db), 1);
ber_simulation_siso = zeros(length(snr_db), 1);

for i = 1:length(snr_db)
    %% SISO
    Y_siso = awgn(y_siso,snr_db(i),'measured');
    Y_siso = Y_siso./H_SISO;
    Y_demod_siso = pskdemod(Y_siso,2); 
    ber_simulation_siso(i) = sum(x'~=Y_demod_siso)/length(x_bpsk);
    
    %% MISO
    % Received Signal => Sum Combines input from the 2 Tx Antennas into 1
    Y_alamouti_miso = awgn(sum(H_MISO.* x_alamouti,2), snr_db(i), 'measured');
    % Alamouti Decoder   
    alamouti_decoding_miso = comm.OSTBCCombiner;
    Y_decoded_miso = alamouti_decoding_miso(Y_alamouti_miso, H_MISO);
    
    % Demodulation
    Y_demod_miso = pskdemod(Y_decoded_miso,2);    
    ber_simulation_miso(i) = sum(x'~=Y_demod_miso)/length(x_bpsk);
    
    %% MIMO 
%   Received Signal => Sum Combines input from the 2 Tx Antennas into 1
    Y_alamouti_mimo = awgn(sum(H_MIMO*x_alamouti'), snr_db(i), 'measured');
    % Alamouti Decoder  
    Y_alamouti_mimo = [Y_alamouti_mimo Y_alamouti_mimo];
    alamouti_decoding_mimo = comm.OSTBCCombiner;
%     Y_alamouti_mimo = [Y_alamouti_mimo' Y_alamouti_mimo'];
    Y_decoded_mimo = alamouti_decoding_mimo(Y_alamouti_mimo', H_MIMO);
    
    % Demodulation
    Y_demod_mimo = pskdemod(Y_decoded_mimo,2);    
    ber_simulation_MIMO(i) = sum(x'~=Y_demod_mimo(1:length(x)))/length(x_bpsk);
    
end
%%
ber_mimo = [0.146402000000000,0.144045000000000,0.142224000000000,0.138374000000000,0.136122000000000,0.134266000000000,0.130977000000000,0.128805000000000,0.125594000000000,0.123742000000000,0.121657000000000,0.118193000000000,0.116508000000000,0.113723000000000,0.111030000000000,0.108759000000000,0.106630000000000,0.104518000000000,0.101313000000000,0.0996530000000000,0.0974250000000000,0.0951080000000000,0.0928960000000000,0.0903800000000000,0.0889250000000000,0.0859420000000000,0.0840200000000000,0.0815400000000000,0.0794660000000000,0.0781540000000000,0.0752390000000000,0.0736560000000000,0.0713950000000000,0.0692120000000000,0.0677350000000000,0.0652510000000000,0.0631770000000000,0.0614780000000000,0.0599510000000000,0.0582170000000000,0.0560760000000000,0.0543810000000000,0.0527770000000000,0.0511690000000000,0.0498320000000000,0.0481510000000000,0.0464150000000000,0.0449540000000000,0.0434050000000000,0.0419080000000000,0.0406290000000000,0.0392750000000000,0.0373380000000000,0.0360260000000000,0.0346000000000000,0.0333160000000000,0.0322100000000000,0.0310980000000000,0.0298730000000000,0.0286920000000000,0.0276000000000000,0.0264460000000000,0.0251550000000000,0.0241850000000000,0.0231840000000000,0.0223590000000000,0.0213400000000000,0.0206210000000000,0.0194700000000000,0.0189860000000000,0.0179920000000000,0.0171170000000000,0.0165820000000000,0.0157950000000000,0.0150670000000000,0.0143050000000000,0.0134960000000000,0.0129100000000000,0.0123790000000000,0.0118340000000000,0.0113360000000000,0.0106120000000000,0.0100230000000000,0.00976800000000000,0.00917700000000000,0.00854900000000000,0.00823600000000000,0.00786100000000000,0.00739400000000000,0.00696600000000000,0.00670800000000000,0.00624400000000000,0.00597200000000000,0.00563000000000000,0.00517400000000000,0.00500700000000000,0.00473100000000000,0.00458100000000000,0.00415600000000000,0.00384900000000000,0.00377000000000000,0.00354500000000000,0.00320900000000000,0.00296300000000000,0.00285800000000000,0.00284300000000000,0.00259000000000000,0.00234000000000000,0.00240000000000000,0.00208100000000000,0.00205100000000000,0.00193000000000000,0.00177600000000000,0.00167500000000000,0.00158700000000000,0.00140200000000000,0.00141100000000000,0.00122100000000000,0.00113200000000000,0.00109200000000000,0.00100100000000000,0.000906000000000000,0.000892000000000000,0.000825000000000000,0.000793000000000000,0.000734000000000000,0.000713000000000000,0.000598000000000000,0.000625000000000000,0.000550000000000000,0.000556000000000000,0.000467000000000000,0.000431000000000000,0.000386000000000000,0.000363000000000000,0.000371000000000000,0.000346000000000000,0.000296000000000000,0.000274000000000000,0.000265000000000000,0.000261000000000000,0.000194000000000000,0.000214000000000000,0.000212000000000000,0.000200000000000000,0.000150000000000000,0.000167000000000000,0.000148000000000000,0.000124000000000000,0.000134000000000000,0.000112000000000000,0.000112000000000000,0.000100000000000000,9.70000000000000e-05,7.50000000000000e-05,9.20000000000000e-05,7.20000000000000e-05,6.30000000000000e-05,6.30000000000000e-05,4.50000000000000e-05,5.60000000000000e-05,4.80000000000000e-05,4.60000000000000e-05,4.00000000000000e-05,3.40000000000000e-05,4.10000000000000e-05,4.20000000000000e-05,2.40000000000000e-05,2.70000000000000e-05,2.30000000000000e-05,2.70000000000000e-05,1.40000000000000e-05,2.10000000000000e-05,1.60000000000000e-05,1.90000000000000e-05,1.10000000000000e-05,1.00000000000000e-05,1.50000000000000e-05,1.50000000000000e-05,1.40000000000000e-05,1.10000000000000e-05,9.00000000000000e-06,8.00000000000000e-06,1.00000000000000e-05,7.00000000000000e-06,6.00000000000000e-06,4.00000000000000e-06,6.00000000000000e-06,6.00000000000000e-06,4.00000000000000e-06,9.00000000000000e-06,3.00000000000000e-06,6.00000000000000e-06,2.00000000000000e-06,2.00000000000000e-06,4.00000000000000e-06,7.00000000000000e-06,1.00000000000000e-06,5.00000000000000e-06,3.00000000000000e-06,0,0,3.00000000000000e-06,1.00000000000000e-06,0,0,2.00000000000000e-06,1.00000000000000e-06,0,2.00000000000000e-06,0,1.00000000000000e-06,0,0,0,2.00000000000000e-06,0,0,1.00000000000000e-06,0,1.00000000000000e-06,1.00000000000000e-06,0,0,0,0,1.00000000000000e-06,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
%% Plots
figure('DefaultAxesFontSize',20);
ber_siso = berfading(Eb_No_dB, 'psk', 2, 1);
semilogy(Eb_No_dB,ber_siso,'b','linewidth',3);
hold on;

lambda = sqrt(Eb_No./(Eb_No+2));
ber_mrc = berfading(Eb_No_dB, 'psk', 2, 2);
semilogy(Eb_No_dB,ber_simulation_miso,'r-','linewidth',3);
semilogy(Eb_No_dB,ber_mrc,'g-','linewidth',3)
semilogy(Eb_No_dB,ber_mimo,'m-','linewidth',3)

grid on;
legend('SISO','2Tx-1Rx: Alamouti Code', '2Tx-1Rx: MRC BER','2Tx-2Rx: Alamouti Code');
title('BER v/s E_b/N_o for 1x2 (MISO) Alamouti Code');
xlabel('E_b/N_o (dB)');
ylabel('BER');

xlim([Eb_No_dB(1) Eb_No_dB(end)]);

%% Conclusion

% It is evident from the plot that the best performance is obtained for
% Alamouti coding with 2Tx-2Rx. The BER for 2Tx-1Rx (MISO) system in which
% Alamouti coding is done and a 1x2 MISO system with Maximal Ratio
% Combining (MRC). SISO system performs the worst as the BER of this system
% is the highest.